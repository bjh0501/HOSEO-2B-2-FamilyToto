<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">


  <!-- Custom fonts for this template-->
  <link th:href="@{vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
  <link th:href="@{css/Nunito.css}" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link th:href="@{css/sb-admin-2.min.css}" rel="stylesheet">
	<style>
		.panel.with-nav-tabs .panel-heading{
		    padding: 5px 5px 0 5px;
		}
		.panel.with-nav-tabs .nav-tabs{
			border-bottom: none;
		}
		.panel.with-nav-tabs .nav-justified{
			margin-bottom: -1px;
		}
		/********************************************************************/
		/*** PANEL DEFAULT ***/
		.with-nav-tabs.panel-default .nav-tabs > li > a,
		.with-nav-tabs.panel-default .nav-tabs > li > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > li > a:focus {
		    color: #777;
		}
		.with-nav-tabs.panel-default .nav-tabs > .open > a,
		.with-nav-tabs.panel-default .nav-tabs > .open > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > .open > a:focus,
		.with-nav-tabs.panel-default .nav-tabs > li > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > li > a:focus {
		    color: #777;
			background-color: #ddd;
			border-color: transparent;
		}
		.with-nav-tabs.panel-default .nav-tabs > li.active > a,
		.with-nav-tabs.panel-default .nav-tabs > li.active > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > li.active > a:focus {
			color: #555;
			background-color: #fff;
			border-color: #ddd;
			border-bottom-color: transparent;
		}
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu {
		    background-color: #f5f5f5;
		    border-color: #ddd;
		}
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a {
		    color: #777;   
		}
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
		    background-color: #ddd;
		}
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a,
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
		.with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
		    color: #fff;
		    background-color: #555;
		}
	</style>
</head>

<body id="page-top">

  <!-- Page Wrapper -->
	<div id="wrapper">

		<ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar" th:include="/sidebar/sidebar">
		</ul>
	
	    <!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">
		
		      <!-- Main Content -->
			<div id="content">
		
		        <!-- Topbar -->
		        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow" th:include="/header/header">
		
		
		        </nav>
		        <!-- End of Topbar -->
		
		        <!-- Begin Page Content -->
				<div class="container-fluid">
					<div class="row">
						<h2 class="text-title">충전</h2>
						&nbsp;<a class="btn btn-light btn-circle" id="helpButton" character="리지" href="javascript:;">
							<i class="fas fa-info-circle"></i>
						</a>
						
						
					</div>
					<div class="row">
						<div class="col-12">
							<div class="card shadow h-100 py-12">
								<div style="padding-bottom:20px;">
									<ul class="nav nav-tabs nav-justified">
										<li class="nav-item">
											<a class="nav-link active"  href="javascript:gubun('free')" id="gubunFree">무료충전</a>
										</li>
										<li class="nav-item">
											<a class="nav-link"  href="javascript:gubun('card')" id="gubunCard">카드결제</a>
										</li>
										<li class="nav-item">
											<a class="nav-link"  href="javascript:gubun('kakao')" id="gubunKakao">카카오페이결제</a>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group">
												<div class="input-group-prepend">
											    	<div class="input-group-text">
														<input type="radio" name="chip" id="chip1" value="one" checked>
													</div>
												</div>
												<select class="custom-select" id="oneCharge" onchange="changeCharge()">
												    <option value="1000" selected>1,000</option>
												    <option value="5000">5,000</option>
												    <option value="7000">7,000</option>
												    <option value="10000">10,000</option>
												</select>	
											</div>
										</div>
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group">
												<div class="input-group-prepend">
											    	<div class="input-group-text">
														<input type="radio"  name="chip" value="two" id="chip2">
											    	</div>
											  	</div>
												<input type="text" class="form-control" placeholder="직접입력" id="twoCharge" numberOnly><div style="padding-top:8px;">&nbsp;크레딧</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="custom-control custom-checkbox mb-3">
											<input type="checkbox" class="custom-control-input" id="mail" required>
											<label class="custom-control-label" for="mail" >
												충전내역 메일로 보내기
											</label>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4" gubun="free">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="input-group">
										<h3>지금까지한 무료 충전 횟수 : <span th:text=${list.totalCharge}>0</span>회</h3>
									</div>
									<div class="input-group">
										<h3>오늘가능한 충전 횟수 : <span th:text=${list.todayCharge}>0</span>회</h3>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4" style="display: none;" gubun="card">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="input-group">
										<h3>총 카드 결제 횟수 : <span th:text=${cardInfo.chargeCnt}>0</span>회</h3>
									</div>
									<div class="input-group">
										<h3>총 카드 결제 크레딧 : <span th:text="${#numbers.formatInteger(cardInfo.creditValue, 0, 'COMMA')}">0</span>크레딧</h3>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="input-group">
										<h3>현재 보유 크레딧 : <span id="nowCredit" th:text="${#numbers.formatInteger(currentCredit, 0, 'COMMA')}">0</span>크레딧</h3>
									</div>
									<div class="input-group">
										<h3>충전 후 크레딧 : <span th:text="${#numbers.formatInteger(currentCredit+1000, 0, 'COMMA')}" id="futureCredit">0</span>크레딧</h3>
									</div>
								</div>
							</div>
						</div>
					</div>			
					<div class="row">
						<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div style="height:150px; overflow-y: scroll;">
										<pre th:include="/shop/service/paymentOfService"></pre> 
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group mb-3"> 
												<div class="custom-control custom-checkbox">
													<input type="checkbox" class="custom-control-input" id="agree">
													<label class="custom-control-label" for="agree">위 내용을 확인하였고, 결제에 동의합니다.</label>
												</div>
											</div>
										</div>
										<div class="col-xl-5 col-lg-5 col-md-12 col-sm-12 mb-4">
											<div class="input-group mb-3">
												<button type="button" class="btn btn-secondary btn-lg btn-block" onClick="charge()" >결제하기</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>			
				</div>
		        <!-- /.container-fluid -->
		
		</div>
	      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white" th:include="/footer/footer">
      
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->
	</div>
  <!-- End of Page Wrapper -->

  

   <!-- Bootstrap core JavaScript-->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Custom scripts for all pages-->
  <script src="/js/sb-admin-2.min.js"></script>
 
 <!-- common -->
  <script src="/js/common.js"></script>
  
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
	<!-- common -->
    <script src="/js/common.js"></script>
	<script src="/js/header.js"></script>
	
</body>

</html>

<script>
var helpCommentList = [
	"충천페이지이에여<br>충천방식은 무료충전,카드결재가있어여.<br>충천내역을 메일로보내기 체크하시면<br>"
	+ "충천한금액이 메일로 보내져여",
	"무료충천은 현재크레딧5000미만일경우만가능하며<br>"
	+ "좌측화면에 충천하고싶은 크레딧을 고르시거나 적으시고<br>"
	+ "결재동의버튼누른뒤 결제하기를 누르시면<br>",
	 "충전이완료되여.<br>"
	+ "카드결재충전도 충전하실 크레딧을적으시고<br>"
	+ "결재동의버튼누른뒤 결제하기를 누르시면<br>",
	+ "충천절차가뜨는데 절차대로완료하시면 <br>크레딧충천이완료되여.<br>",
	+ "단 무료충전은 하루에최대5번이며<br>카드결재는 하루에 최대30만까지만가능하고<br>"
	+ "한번결재할때 최고금액은 만원이에여"]

	var chargeGubun = "free";
	var IMP = window.IMP; // 생략가능
	IMP.init('imp02311696'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용
	
	function charge() {
		var st = $(":input:radio[name=chip]:checked").val();
		var mail = "N";
		var credit;
		
		if($("input:checkbox[id='mail']").is(":checked") == true) {
			mail = "Y";
		}
		
		if(st == "one") {
			credit = $("#oneCharge").val()
		} else {
			credit = $("#twoCharge").val()
		}
		
		if(chargeGubun == "free") {
			if(parseInt(removeComma($("#nowCredit").html())) >= 5000) {
				alert("현재 크레딧이 5,000크레딧미만 이여야만 충전을 할 수 있습니다.");
				return false;
			}
			
			if(parseInt(credit) > 10000) {
				alert("10,000크레딧 이하로 충전할 수 있습니다.");
				$("#twoCharge").focus();
				return false;
			}
			
			if($("input:checkbox[id='agree']").is(":checked") == false) {
				alert("약관에 동의해야만 결제를 할 수 있습니다");
				$("#agree").focus()
				return false;
			}

			$.ajax({
				url : "/charge/doCharge?gubun=FREE",
				type : "POST",
				cache : false,
				async : false,
				dataType : "json",
				data : "creditValue=" + encodeURIComponent(parseInt(credit)) 
				+ "&mail=" + mail
				+ "&emailAddress=" + '[[ ${custEmail} ]]',
				success : function(data) {
					if(data == 0) {
						alert("충전에 성공하였습니다.");
						location.reload();
					} else if(data == 1) {
						if(mail == "N") {
							alert("충전에 성공하였습니다.");
							location.reload();
						} else {
							alert("충전에는 성공했으나,\n이메일 정보가 없어서 충전내역을 메일로 보내지 못하였습니다.");
							location.reload();
						}
					} else if(data == -98) {
						alert("충전할 수 있는 횟수를 초과하였습니다.");
					} else {
						alert("새로고침후 다시 시도해주세요.");
					}
				},

				error : function(request, status, error) {
					var msg = "ERROR : " + request.status + "<br>"
					msg += +"내용 : " + request.responseText + "<br>" + error;
					console.log(msg);
				}
			});
		} else {
			if($("input:checkbox[id='agree']").is(":checked") == false) {
				alert("약관에 동의해야만 결제를 할 수 있습니다");
				$("#agree").focus()
				return false;
			}
			
			IMP.request_pay({
			    pg : 'uplus', // version 1.1.0부터 지원.
			    pay_method : 'card',
			    merchant_uid : 'merchant_' + new Date().getTime(),
			    name : "크레딧 충전",
			    amount : parseInt(credit),
			    buyer_name : '[[ ${custNickname} ]]',
			    buyer_email : '[[ ${custEmail} ]]'
			}, function(rsp) {
			    if ( rsp.success ) {
			        var msg = '결제가 완료되었습니다.';
			        //msg += '고유ID : ' + rsp.imp_uid;
			        //msg += '상점 거래ID : ' + rsp.merchant_uid;
			        msg += '\n결제 금액 : ' + numberWithCommas(rsp.paid_amount);
			        //msg += '카드 승인번호 : ' + rsp.apply_num;
			        
			        $.ajax({
						url : "/charge/doCharge?gubun=CARD",
						type : "POST",
						cache : false,
						dataType : "json",
						async : false,
						data : "creditValue=" + encodeURIComponent(parseInt(credit)) 
						+ "&mail=" + mail
						+ "&emailAddress=" + '[[ ${custEmail} ]]',
						success : function(data) {
							if(data == 0) {
								alert(msg);
								location.reload();
							} else if(data == 1) {
								if(mail == "N") {
									alert(msg);
									location.reload();
								} else {
									alert("결제에는 성공했으나,\n이메일 정보가 없어서 충전내역을 메일로 보내지 못하였습니다.");
									location.reload();
								}
							} else if(data == -96) {
								alert("하루 최대 300,000크레딧만 충전가능합니다.");
							} else {
								alert("새로고침후 다시 시도해주세요.");
							}
						},
						error : function(request, status, error) {
							var msg = "ERROR : " + request.status + "<br>"
							msg += +"내용 : " + request.responseText + "<br>" + error;
							console.log(msg);
						}
					});
			    } else {
			        var msg = '결제에 실패하였습니다.';
			        msg += '에러내용 : ' + rsp.error_msg;
			    }
			});
		}
	}
	
	var input = document.getElementById('twoCharge')
	
	input.onkeyup = function(event) {
		$("#chip2").prop("checked", true)
		
		var charge = 0;
		if($("#twoCharge").val() == "") {
			charge = 0;
		} else {
			charge = $("#twoCharge").val();
		}
		
		var chargeValue = parseInt(charge);
		var now = parseInt(removeComma($("#nowCredit").html()));
		var future = numberWithCommas(now +  chargeValue);
		
		if(charge == 0) {
			$("#futureCredit").html(now);
		} else {
			$("#futureCredit").html(future);			
		}
	}
	
	function changeCharge() {
		$("#chip1").prop("checked", true)
		
		var now = parseInt(removeComma($("#nowCredit").html()));
		var future = numberWithCommas(now +  parseInt($("#oneCharge").val()));
		
		$("#futureCredit").html(future);
	}
	
	function gubun(gubun) {
		if(gubun == "card") {
			$("[gubun='card']").attr("style", "");
			$("[gubun='free']").attr("style", "display: none");
			$("#gubunFree").removeClass("active");
			$("#gubunCard").addClass("active");
			chargeGubun = "card";	
		} else {
			$("[gubun='free']").attr("style", "");
			$("[gubun='card']").attr("style", "display: none");
			$("#gubunFree").addClass("active");
			$("#gubunCard").removeClass("active");
			chargeGubun = "free";
		}
	}
</script>