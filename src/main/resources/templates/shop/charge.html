<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">


  <!-- Custom fonts for this template-->
  <link th:href="@{vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
  <link th:href="@{css/Nunito.css}" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link th:href="@{css/sb-admin-2.min.css}" rel="stylesheet">

</head>

<body id="page-top">

  <!-- Page Wrapper -->
	<div id="wrapper">

		<ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar" th:include="/sidebar/sidebar">
		</ul>
	
	    <!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">
		
		      <!-- Main Content -->
			<div id="content">
		
		        <!-- Topbar -->
		        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow" th:include="/header/header">
		
		
		        </nav>
		        <!-- End of Topbar -->
		
		        <!-- Begin Page Content -->
				<div class="container-fluid">
					<div class="row">
						<h2 class="text-title">충전</h2>
					</div>
					<div class="row">
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group">
												<div class="input-group-prepend">
											    	<div class="input-group-text">
														<input type="radio" name="chip" id="chip1" value="one" checked>
													</div>
												</div>
												<select class="custom-select" id="oneCharge" onchange="changeCharge()">
												    <option value="1000" selected>1,000</option>
												    <option value="5000">5,000</option>
												    <option value="7000">7,000</option>
												    <option value="10000">10,000</option>
												</select>	
											</div>
										</div>
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group">
												<div class="input-group-prepend">
											    	<div class="input-group-text">
														<input type="radio"  name="chip" value="two" id="chip2">
											    	</div>
											  	</div>
												<input type="text" class="form-control" placeholder="직접입력" id="twoCharge"><div style="padding-top:8px;">&nbsp;크레딧</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="custom-control custom-checkbox mb-3">
											<input type="checkbox" class="custom-control-input" id="mail" required>
											<label class="custom-control-label" for="mail" >
												충전내역 메일로 보내기
											</label>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="input-group">
										<h3>지금까지한 충전 횟수 : <span th:text=${list.totalCharge}>12</span>회</h3>
									</div>
									<div class="input-group">
										<h3>오늘가능한 충전 횟수 : <span th:text=${list.todayCharge}>12</span>회</h3>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-6 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="input-group">
										<h3>현재 보유 크레딧 : <span id="nowCredit" th:text="${#numbers.formatInteger(currentCredit, 0, 'COMMA')}">0</span>크레딧</h3>
									</div>
									<div class="input-group">
										<h3>충전 후 크레딧 : <span th:text="${#numbers.formatInteger(currentCredit+1000, 0, 'COMMA')}" id="futureCredit">0</span>크레딧</h3>
									</div>
								</div>
							</div>
						</div>
					</div>			
					<div class="row">
						<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div style="height:150px; overflow-y: scroll;">
										<pre th:include="/shop/service/paymentOfService"></pre> 
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-4">
							<div class="card shadow h-100 py-12">
								<div style="padding:20px;">
									<div class="row">
										<div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-4">
											<div class="input-group mb-3"> 
												<div class="custom-control custom-checkbox">
													<input type="checkbox" class="custom-control-input" id="agree">
													<label class="custom-control-label" for="agree">위 내용을 확인하였고, 결제에 동의합니다.</label>
												</div>
											</div>
										</div>
										<div class="col-xl-5 col-lg-5 col-md-12 col-sm-12 mb-4">
											<div class="input-group mb-3">
												<button type="button" class="btn btn-secondary btn-lg btn-block" onClick="charge()">결제하기</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>			
				</div>
		        <!-- /.container-fluid -->
		
		</div>
	      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white" th:include="/footer/footer">
      
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->
	</div>
  <!-- End of Page Wrapper -->

  

   <!-- Bootstrap core JavaScript-->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Custom scripts for all pages-->
  <script src="/js/sb-admin-2.min.js"></script>
 
 <!-- common -->
  <script src="/js/common.js"></script>
</body>

</html>

<script>
	function charge() {
		var st = $(":input:radio[name=chip]:checked").val();
		var mail = "N";
		var credit;
		
		if($("input:checkbox[id='mail']").is(":checked") == true) {
			mail = "Y";
		}
		
		if(st == "one") {
			credit = $("#oneCharge").val()
		} else {
			credit = $("#twoCharge").val()
		}
		
		if(parseInt($("#nowCredit").html()) >= 5000) {
			alert("현재 크레딧이 5,000크레딧미만 이여야만 충전을 할 수 있습니다.");
			return
		}
		
		if(parseInt(credit) > 10000) {
			alert("10,000크레딧 이하로 충전할 수 있습니다.");
			$("#twoCharge").focus();
			return
		}
		
		if($("input:checkbox[id='agree']").is(":checked") == false) {
			alert("약관에 동의해야만 결제를 할 수 있습니다");
			$("#agree").focus()
			return
		}
		
		$.ajax({
			url : "/charge/doCharge",
			type : "POST",
			cache : false,
			dataType : "json",
			data : "creditValue=" + encodeURIComponent(parseInt(credit)) 
			+ "&mail=" + mail,
			success : function(data) {
				if(data == 0) {
					alert("충전에 성공하였습니다.");
					location.reload();
				} else if(data == 1) {
					if(mail == "N") {
						alert("충전에 성공하였습니다.");
						location.reload();
					} else {
						alert("충전에는 성공했으나,\n이메일 정보가 없어서 충전내역을 메일로 보내지 못하였습니다.");
						location.reload();
					}
				} else if(data == -98) {
					alert("충전할 수 있는 횟수를 초과하였습니다.");
				} else {
					alert("새로고침후 다시 시도해주세요.");
				}
			},

			error : function(request, status, error) {
				var msg = "ERROR : " + request.status + "<br>"
				msg += +"내용 : " + request.responseText + "<br>" + error;
				console.log(msg);
			}
		});
	}
	
	var input = document.getElementById('twoCharge')
	
	input.onkeyup = function(event) {
		$("#chip2").prop("checked", true)
		
		var chargeValue = parseInt($("#twoCharge").val())
		var now = parseInt(removeComma($("#nowCredit").html()));
		var future = numberWithCommas(now +  chargeValue);
		
		if($("#twoCharge").val() == "") {
			$("#futureCredit").html(now);
		} else {
			$("#futureCredit").html(future);			
		}
	}
	
	function changeCharge() {
		$("#chip1").prop("checked", true)
		
		var now = parseInt(removeComma($("#nowCredit").html()));
		var future = numberWithCommas(now +  parseInt($("#oneCharge").val()));
		
		$("#futureCredit").html(future);
	}
</script>