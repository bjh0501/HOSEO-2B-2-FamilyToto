<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>One Sports</title>

<!-- Custom fonts for this template-->
<link th:href="@{vendor/fontawesome-free/css/all.min.css}"
	rel="stylesheet" type="text/css">
<link th:href="@{css/Nunito.css}" rel="stylesheet">

<!-- Custom styles for this template-->
<link th:href="@{css/sb-admin-2.min.css}" rel="stylesheet">

<style>
.list-group {
	max-height: 300px;
	margin-bottom: 10px;
	overflow-y: scroll;
	-webkit-overflow-scrolling: touch;
}
</style>
</head>

<body id="page-top">

	<!-- Page Wrapper -->
	<div id="wrapper">

		<ul
			class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
			id="accordionSidebar" th:include="/sidebar/sidebar">
		</ul>

		<!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">
			<!-- Main Content -->
			<div id="content">

				<!-- Topbar -->
				<nav
					class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
					th:include="/header/header"></nav>
				<!-- End of Topbar -->

				<!-- Begin Page Content -->
				<div class="container-fluid">
					<div class="row">
						<h2 class="text-title">정보수정</h2>
					</div>

					<div class="row">
						<div class="col-xl-12 col-md-12 mb-12">
							<div class="card shadow h-100 py-12">
								<div style="padding: 20px;">
									<div class="row">
										<h1>회원정보</h1>
									</div>

									<label>아이디</label> <input type="text" class="form-control"
										placeholder="ID" aria-label="Username"
										th:value="${list.custId}" disabled><br> <label>닉네임</label>
									<div class="row">
										<div class="col-xl-6 col-md-6 mb-6">
											<input type="text" class="form-control"
												placeholder="Nickname" aria-label="Nickname"
												th:value="${list.familyCustNickname}" disabled>
										</div>
										<div class="col-xl-6 col-md-6 mb-6">
											<div>
												<label style="padding-top: 6px;">*닉네임은 <a href="#">닉네임
														변경권</a>으로만 변경이 가능합니다.
												</label>
											</div>

										</div>
									</div>
									<br> <label>이메일</label>
									<div class="row">
										<div class="col-xl-4 col-md-4 mb-4">
											<input type="text" class="form-control" placeholder="E-mail"
												aria-label="E-mail" th:value="${list.email1}" id="email1">
										</div>
										<label style="padding-top: 6px;">@</label>
										<div class="col-xl-4 col-md-4 mb-4">
											<input type="text" class="form-control" placeholder="E-mail"
												aria-label="E-mail" th:value="${list.email2}" id="email2">
										</div>
										<div class="col-xl-3 col-md-3 mb-3">
											<select class="custom-select" id="emailChoose"
												onChange="chooseEmail()">
												<option selected value="J">직접선택</option>
												<option value="N">Naver.com</option>
												<option value="D">Daum.net</option>
												<option value="G">Google.com</option>
											</select>
										</div>
									</div>
									<hr>
									<h1>
										<label>주소</label>
									</h1>
									<div class="row">
										<div class="col-xl-4 col-md-4 mb-4">
											<span>시</span>
											<div class="input-group mb-3">
												<select class="custom-select" id="sido"
													onChange="getGugun();" th:value="${list.familyCustAddrSi}">
													<option selected="">시</option>
												</select>
											</div>
										</div>
										<div class="col-xl-4 col-md-4 mb-4">
											<span>구/군</span> <select class="custom-select" id="gugun"
												onchange="getDong()" th:value="${list.familyCustAddrGugun}">
												<option selected="">구/군</option>
											</select>
										</div>
										<div class="col-xl-4 col-md-4 mb-4">
											<span>동</span> <select class="custom-select" id="dong"
												onchange="getZipList()">
												<option selected="">동</option>
											</select>
										</div>
									</div>
									<div class="row">
										<div class="col-xl-12 col-md-12 mb-12">
											<div class="input-group mb-3">
												<span class="text-word-r">상세주소</span> <input type="text"
													class="form-control" placeholder="Address"
													aria-label="Address" id="addr" th:value="${list.familyCustAddr}">
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<nav id="navbar-example2"
												class="navbar navbar-light bg-light">
												<h2>우편번호 리스트</h2>
											</nav>
											<div data-spy="scroll" data-target="#navbar-example2"
												data-offset="0">
												<div class="list-group" id="list-tab" role="tablist">

												</div>
											</div>
										</div>
									</div>
									<hr>
									<label>현재 비밀번호</label> <input type="password"
										class="form-control" placeholder="Current Password"
										aria-label="Password" id="currentPass"><br> <label>새
										비밀번호</label> <input type="password" class="form-control"
										placeholder="New Password" aria-label="Password check"
										id="newPass"><br> <label>새 비밀번호 확인</label> <input
										type="password" class="form-control"
										placeholder="New Password Check" aria-label="Password check"
										id="newPassCheck"><br>

									<hr />
									<div class="row">
										<h1>소셜연동</h1>
									</div>
									<div class="row">
										<label>페이스북</label>
										<div style="margin-left: 7px;">
											<div class="custom-control custom-switch"
												onclick="javascript:facebookAuth()">
												<input type="checkbox" class="custom-control-input"
													id="facebook"> <label class="custom-control-label"
													name="facebook">비연동</label>
											</div>
										</div>
									</div>
									<input type="text" class="form-control"
										placeholder="연동을 하시려면 클릭해주세요." aria-label="Username"
										id="facebookEmail" disabled th:value="${list.FA}"><br>
									<div class="row">
										<label>카카오</label>
										<div style="margin-left: 7px;">
											<div class="custom-control custom-switch"
												onclick="javascript:auth('kakao')">
												<input type="checkbox" class="custom-control-input"
													id="kakao"> <label class="custom-control-label"
													name="kakao">비연동</label>
											</div>
											<a th:href="${kakaoUrl}" style="display: none" id="kakaoLink"></a>
										</div>
									</div>
									<input type="text" class="form-control"
										placeholder="연동을 하시려면 클릭해주세요." aria-label="Username"
										id="kakaoEmail" disabled th:value="${list.KA}"><br>
									<div class="row">
										<label>네이버</label>
										<div style="margin-left: 7px;">
											<div class="custom-control custom-switch"
												onclick="javascript:auth('naver')">
												<input type="checkbox" class="custom-control-input"
													id="naver"> <label class="custom-control-label"
													name="naver">비연동</label>
											</div>
											<a th:href="${naverUrl}" style="display: none" id="naverLink"></a>
										</div>
									</div>
									<input type="text" class="form-control"
										placeholder="연동을 하시려면 클릭해주세요." aria-label="Username"
										id="naverEmail" disabled th:value="${list.NA}"> <br>
									<div class="row">
										<div class="col-xl-6 col-md-6 mb-6">
											<div class="input-group mb-3">
												<button type="button" class="btn btn-secondary btn-block"
													onClick="drop()">탈퇴하기</button>
											</div>
										</div>
										<div class="col-xl-6 col-md-6 mb-6">
											<div class="input-group mb-3">
												<button type="button" class="btn btn-secondary btn-block"
													onClick="javascript:changeCust();">수정하기</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- /.container-fluid -->

			</div>
			<!-- End of Main Content -->

			<!-- Footer -->
			<br>
			<footer class="sticky-footer bg-white" th:include="/footer/footer">

			</footer>
			<!-- End of Footer -->

		</div>
		<!-- End of Content Wrapper -->
	</div>
	<!-- End of Page Wrapper -->



	<!-- Bootstrap core JavaScript-->
	<script th:src="@{vendor/jquery/jquery.min.js}"></script>
	<script th:src="@{vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

	<!-- Core plugin JavaScript-->
	<script th:src="@{vendor/jquery-easing/jquery.easing.min.js}"></script>

	<!-- Custom scripts for all pages-->
	<script th:src="@{js/sb-admin-2.min.js}"></script>

	<!-- Page level plugins -->
	<script th:src="@{vendor/chart.js/Chart.min.js}"></script>

	<!-- Page level custom scripts -->
	<script th:src="@{js/demo/chart-area-demo.js}"></script>
	<script th:src="@{js/demo/chart-pie-demo.js}"></script>
</body>

</html>
<script>
getSido("[[ ${list.familyCustAddrSi} ]]");
getGugun("[[ ${list.familyCustAddrGugun} ]]");
getDong("[[ ${list.familyCustAddrDong} ]]");
getZipList();

function getSido(getData) {
	$.ajax({
		url : "/zipcode/getSido",
		type : "POST",
		cache : false,
		async : false,
		dataType : "json",
		success : function(data) {
			var sStr = "";
			
			for(var i = 0;i < data.length; i++) {
				var sSido = data[i].sido;
				sStr += "<option value='" + sSido + "'>" + sSido + "</option>";
			}
			
			$("#sido").html(sStr);
			
			if(getData != undefined) {
				$("#sido").val(getData);
			}
			
			getGugun();
		},
		error : function(request, status, error) {
			var msg = "ERROR : " + request.status + "<br>"
			msg += +"내용 : " + request.responseText + "<br>" + error;
			console.log(msg);
		}
	});
}

function getGugun(getData) {
	$.ajax({
		url : "/zipcode/getGugun",
		type : "POST",
		cache : false,
		async : false,
		dataType : "json",
		data : "sido=" + $("#sido").val(),
		success : function(data) {
			var sStr = "";
			
			for(var i = 0;i < data.length; i++) {
				var sData = data[i].gugun;
				sStr += "<option value='" + sData + "'>" + sData + "</option>";
			}
			
			$("#gugun").html(sStr);
			if(getData != undefined) {
				$("#gugun").val(getData);
			}
			
			getDong();
		},
		error : function(request, status, error) {
			var msg = "ERROR : " + request.status + "<br>"
			msg += +"내용 : " + request.responseText + "<br>" + error;
			console.log(msg);
		}
	});
}

function getDong(getData) {
	$.ajax({
		url : "/zipcode/getDong",
		type : "POST",
		cache : false,
		async : false,
		dataType : "json",
		data : "sido=" + $("#sido").val()
				+ "&gugun=" + $("#gugun").val(),
		success : function(data) {
			var sStr = "";
			
			for(var i = 0;i < data.length; i++) {
				var sData = data[i].dong;
				sStr += "<option value='" + sData + "'>" + sData + "</option>";
			}
			
			$("#dong").html(sStr);
			if(getData != undefined) {
				$("#dong").val(getData);			
			}
			
			getZipList();
		},
		error : function(request, status, error) {
			var msg = "ERROR : " + request.status + "<br>"
			msg += +"내용 : " + request.responseText + "<br>" + error;
			console.log(msg);
		}
	});
}

function getZipList() {
	$.ajax({
		url : "/zipcode/getZip",
		type : "POST",
		cache : false,
		async : false,
		dataType : "json",
		data : "sido=" + $("#sido").val()
				+ "&gugun=" + $("#gugun").val()
				+ "&dong=" + $("#dong").val(),
		success : function(data) {
			var sStr = "";
			var sListLi = "";
			
			for(var i = 0;i < data.length; i++) {
				var sData = data[i].ri;
				var sListData = "";

				sListData += "<a class='list-group-item list-group-item-action '";
				sListData += "data-toggle='list' href='javascript:;' onClick='javascript:chooseZip($(this));'";
				sListData += "role='tab' >" + sData + "</a>";
				
				sListLi += sListData; 
			}
			
			$("#list-tab").html(sListLi);
		},
		error : function(request, status, error) {
			var msg = "ERROR : " + request.status + "<br>"
			msg += +"내용 : " + request.responseText + "<br>" + error;
			console.log(msg);
		}
	});
}

function chooseZip(obj) {
	$("#addr").val(obj.html());
}

	$(document).ready(function() {
		if($("#naverEmail").val() != "") {
			$("input:checkbox[id='naver']").prop("checked", true)
			$("[name=naver]").html("연동")
		}
	
		if($("#kakaoEmail").val() != "") {
			$("input:checkbox[id='kakao']").prop("checked", true)
			$("[name=kakao]").html("연동")
		}
	
		if($("#facebookEmail").val() != "") {
			$("input:checkbox[id='facebook']").prop("checked", true)
			$("[name=facebook]").html("연동")
		}
	});


	function chooseEmail() {
		ec = $("#emailChoose").val()
		email2 = $("#email2")
		
		email2.prop('disabled', true);
		
		if(ec == "J") {
			email2.val("");
			email2.prop('disabled', false);
		} else if(ec == "N") {
			email2.val("naver.com");
		} else if(ec == "D") {
			email2.val("daume.net");
		} else {
			email2.val("google.com");
		}
	}
	
	function changeCust() {
		email1 = $("#email1");
		email2 = $("#email2");		
		email = email1.val() +"@"+ email2.val();
		addr = $("#addr");
		
		currentPass = $("#currentPass");
		newPass = $("#newPass");
		newPassCheck = $("#newPassCheck");
		
		if(currentPass.val() == "") {
			 alert("회원정보를 수정하려면 비밀번호를 입력해야합니다.");
			 currentPass.focus();
			 return;
		}
		
		
		if(newPass.val() != "") {
			if (newPass.val().length < 4 || newPass.val().length > 20) {
				alert("비밀번호는 4~20자리까지 입력이 가능합니다.");
				newPass.focus();
				return;
			}
		}
		
		if(newPass.val() != newPassCheck.val()) {
			 alert("새 비밀번호와 새 비밀번호 확인이 다릅니다.");
			 newPassCheck.focus();
			 return;
		}
		
		$.ajax({
			url : "/changeCust/change",
			type : "POST",
			cache : false,
			async : false,
			dataType : "json",
			data : "familyCustEmail=" + email 
			+ "&familyCustAddr=" + addr.val()
			+ "&familyCustAddrSi=" + $("#sido").val()
			+ "&familyCustAddrGugun=" + $("#gugun").val()
			+ "&familyCustAddrDong=" + $("#dong").val()
			+ "&currentPassword=" + currentPass.val()
			+ "&newPassword=" + newPassCheck.val(),
			success : function(data) {
				if(data == 2) {
					alert("변경에 성공하였습니다.");
				}
				
				if(data == -99) {
					alert("현재 비밀번호가 틀려서 수정에 실패하였습니다.")
				}
			},
			error : function(request, status, error) {
				var msg = "ERROR : " + request.status + "<br>"
				msg += +"내용 : " + request.responseText + "<br>" + error;
				console.log(msg);
			}
		});
	}
	
	function drop() {
		if($("#currentPass").val() == "") {
			alert("비밀번호를 입력해주세요.");
			$("#currentPass").focus();
			 return ;
		}
		
		if(confirm("회원탈퇴를 해도 복구가 가능하지만 운영자 마음입니다. ㅎ\n계속 진행하시겠습니까?")) {
			$.ajax({
				url : "changeCust/dropCust",
				type : "POST",
				cache : false,
				async : false,
				dataType : "json",
				data : "custPassword=" + $("#currentPass").val(),
				success : function(data) {
					if(data == -98) {
						alert("비밀번호가 틀렸습니다.");
						return;
					} else if(data==0){
						alert("탈퇴에 성공하였습니다.\n소셜아이디는 이용할 수 있습니다.");
						location.replace("/");
					} else {
						alert("알수없는 에러가 발생하였습니다.")
					}
				},
				error : function(request, status, error) {
					var msg = "ERROR : " + request.status + "<br>"
					msg += +"내용 : " + request.responseText + "<br>" + error;
					console.log(msg);
				}
			});
		}
	}
	
	function successNaver(email) {
		$("#naverEmail").val(email);
		$("input:checkbox[id='naver']").prop("checked", true);
		$("[name='naver']").html("연동");
	}
	
	function successKakao(email) {
		$("#kakaoEmail").val(email);
		$("input:checkbox[id='kakao']").prop("checked", true);
		$("[name='kakao']").html("연동");
	}
	
	function successFacebook(email) {
		$("#facebookEmail").val(email);
		$("input:checkbox[id='facebook']").prop("checked", true);
		$("[name='facebook']").html("연동");
	}
	
	function auth(social) {
		if($("input:checkbox[id='" + social + "']").is(":checked") == false) {
			var link = $("#" + social + "Link").attr("href") + "&authCheck=check"
			var popupX = (document.body.offsetWidth / 2) - (680 / 2);
			var popupY= (document.body.offsetHeight / 2) - (650 / 2);
			
			window.open(link, '', 'status=no, height=680, width=650, left='+ popupX + ', top='+ popupY);
		} else {			
			$.ajax({
				url : "changeCust/social/" + social + "/unAuth",
				type : "POST",
				cache : false,
				dataType : "json",
				data : "a=a",
				success : function(data) {
					if(data == -99) {
						alert("해당 소셜로 로그인중이라 연동해제를 할 수 없습니다.")
						return
					}
					$("#" + social + "Email").val("");
					$("input:checkbox[id='" + social + "']").prop("checked", false)
					$("[name='" +  social + "']").html("비연동")
				},		
				error : function(request, status, error) {
					var msg = "ERROR : " + request.status + "<br>"
					msg += +"내용 : " + request.responseText + "<br>" + error;
					console.log(msg);
				}
			});
		}
	}
</script>


<script>
window.fbAsyncInit = function() {
FB.init({
    appId            : '380846455933511',
    autoLogAppEvents : true,
    xfbml            : true,
    version          : 'v2.7'
  });
}

function getUserData() {
    FB.api('/me','GET', {"fields": 'name,email,id,age_range'}, function(response) {
    	// alert(JSON.stringify(response));
    	id = response.id
    	name = response.name
    	email = response.email
    	/*age = response.age_range.min // 18세 이상만 가입가능
    	
    	if(age < 18) {
    		alert("성인만 가입할 수 있습니다.");
    		return;
    	}*/
    	
    	$.ajax({
			url : "/login/social/facebook/auth",
			type : "POST",
			cache : false,
			dataType : "json",
			data : "scCustId=" + id
					+ "&scCustEmail=" + email
					+ "&scCustNick=" + name
					+ "&scCustGubun=" + "FA",
			success : function(data) {
				if(data == -99) {
					alert('다른사람이 쓰고있는 계정이라 연동을 할 수 없습니다.');
				} else if(data == 0) {
					alert("연동에 성공하였습니다.");
					$("#facebookEmail").val(email);
					$("input:checkbox[id='facebook']").prop("checked", true);
					$("[name='facebook']").html("연동");
				}
			},
			error : function(request, status, error) {
				var msg = "ERROR : " + request.status + "<br>"
				msg += +"내용 : " + request.responseText + "<br>" + error;
				console.log(msg);
			}
		});
    });
}

function facebookAuth() {
	if($("input:checkbox[id='facebook']").is(":checked") == false) {
	 FB.login(function(response) {
	        if (response.authResponse) {
	            getUserData();
	        }
	    }, {scope: 'email,public_profile,age_range',
	        return_scopes: true});
	} else {
		$.ajax({
			url : "changeCust/social/facebook/unAuth",
			type : "POST",
			cache : false,
			dataType : "json",
			data : "a=a",
			success : function(data) {
				if(data == -99) {
					alert("해당 소셜로 로그인중이라 연동해제를 할 수 없습니다.")
					return
				}
				
				$("#facebookEmail").val("");
				$("input:checkbox[id='facebook']").prop("checked", false)
				$("[name='facebook']").html("비연동")
			},		
			error : function(request, status, error) {
				var msg = "ERROR : " + request.status + "<br>"
				msg += +"내용 : " + request.responseText + "<br>" + error;
				console.log(msg);
			}
		});
	}
}
</script>
<script async defer src="https://connect.facebook.net/en_US/sdk.js">
</script>