<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="boardComment">
	<insert id="insertComment">
		INSERT INTO COMMENT
		    (BOARD_NO, 				COMMENT_GRP_NO,     COMMENT_GRP_ORD,		COMMENT_GRP_DEPTH, 
		    COMMENT_CONTENTS,		COMMENT_ANNO_ID, 	COMMENT_ANNO_PW,		REG_CUST_NO, 
		    REG_DT,					REG_IP, 			USE_YN)
		VALUES
		    (#{boardNo},			1,					1,						1,
		    #{commentContents},		#{commentAnnoId},	#{commentAnnoPw},		${regCustNo},
		    now(),					#{regIp},			'Y');
	</insert>
	<select id="getListComment" resultType="com.familytoto.familytotoProject.comment.domain.CommentVO">
        SELECT	IFNULL(IFNULL(C.COMMENT_ANNO_ID, SC.SC_CUST_NICK), FC.FAMILY_CUST_NICKNAME) as commentAnnoId
		,		IFNULL(C.CHG_DT, C.REG_DT) as regDt
		,		C.COMMENT_CONTENTS as commentContents
		,		C.COMMENT_NO as commentNo
		,		IFNULL(IFNULL(CUST.CUST_NO, SC.SC_CUST_NO), 0) AS regCustNo
		,		IF(ISNULL(C.COMMENT_ANNO_ID), IFNULL(SC.SC_CUST_GUBUN, 'ON'), 'AN') AS scCustGubun
		FROM	COMMENT C
			INNER JOIN BOARD B ON B.BOARD_NO = C.BOARD_NO AND B.USE_YN = 'Y' 
			LEFT OUTER JOIN SOCIAL_CUSTOM SC ON SC.SC_CUST_NO = C.REG_CUST_NO AND SC.USE_YN ='Y'
			LEFT OUTER JOIN CUSTOM CUST ON CUST.CUST_NO = C.REG_CUST_NO AND CUST.USE_YN ='Y' 
			LEFT OUTER JOIN FAMILY_CUSTOM FC ON FC.FAMILY_CUST_NO = CUST.FAMILY_CUST_NO AND FC.USE_YN ='Y'
		WHERE	C.USE_YN = 'Y'
		AND		B.BOARD_NO = #{boardNo}
	    AND		IFNULL(IFNULL(C.COMMENT_ANNO_ID, SC.SC_CUST_NICK), FC.FAMILY_CUST_NICKNAME) IS NOT NULL
		ORDER BY COMMENT_NO DESC;
	</select>
	<update id="deleteComment">
		UPDATE	COMMENT
	    SET		USE_YN = 'N'
	    ,		CHG_IP = #{chgIp} 
	    ,		CHG_DT = NOW()
	    ,		CHG_CUST_NO = #{chgCustNo}
	    WHERE	USE_YN = 'Y'
	    AND		REG_CUST_NO = #{chgCustNo}
	    AND		COMMENT_NO = #{commentNo}
	</update>
	<update id="deleteAnnoComment">
		UPDATE	COMMENT
	    SET		USE_YN = 'N'
	    ,		CHG_DT = NOW()
	    ,		CHG_IP = #{chgIp}
	    WHERE	USE_YN = 'Y'
	    AND		COMMENT_NO = #{commentNo}
	</update>
	<select id="checkAnnoCommentPass" resultType="com.familytoto.familytotoProject.comment.domain.CommentVO">
		SELECT	COMMENT_ANNO_PW as commentAnnoPw
        FROM	COMMENT
        WHERE	COMMENT_NO = #{commentNo}
        AND		USE_YN = 'Y'
	</select>
	<update id="updateComment">
		UPDATE	COMMENT
        SET		COMMENT_CONTENTS = #{commentContents}
        ,		CHG_CUST_NO = #{chgCustNo}
        ,		CHG_DT = NOW()
        ,		CHG_IP = #{chgIp}
        WHERE	COMMENT_NO = #{commentNo}
        AND		USE_YN = 'Y'
	</update>
</mapper>